---
title: "BI_basic_datavis_tasks_2_2024"
author: "NataliaLaskina"
date: "2024-10-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE, fig.width=16, fig.height=10)

library(tidyverse)
library(ggpubr)
library(gridExtra)
```

## Загрузка данных

```{r}

hogwarts <- read_csv("data/hogwarts_2024.csv")
hogwarts |> head()

```

### Проверка структуры данных

```{r}

hogwarts |> glimpse()

# Changing some variables type to factors
hogwarts <- hogwarts |> mutate(
  across(c(house, course, sex, wandCore, bloodStatus), ~ as.factor(.x))
)

```

### Поиск пропущенных значений

```{r}
sum(is.na(hogwarts))
```

### Сводка по данным

```{r}
hogwarts |> summary()
```

### Пересоздание theme_custom

```{r}

theme_custom <- theme(
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    strip.text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 25),
    legend.title = element_text(size = 25),
    legend.text = element_text(size = 20)
  )

```

## Визуализация

### Диаграммы рассеяния (скаттерплоты)

#### Первый скаттерплот

Постройте скаттерплот, визуализирующий связь между суммарным баллом студента за год и оценкой за экзамен по травологии. Добавьте на график линию тренда. Удалите доверительную область и сделайте линию прямой. Подумайте, как избежать того, чтобы записать одни и те же координаты x и y дважды. Проинтерпретируйте график.

```{r}

scatterplot_0 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Herbology exam`))+
  geom_point(shape = 21, 
             size = 3, color = "blue", fill = "lightgreen", stroke = 1.5)+
  geom_smooth(se = FALSE,
              color = "red",
              method = "lm",
              linetype = "dashed", 
              linewidth = 3)+
  xlab(label = "Year_score")+
  theme_custom

scatterplot_0
```

Интерпретация. Оценка за экзамен по травологии имеет положительную корреляцию с суммарным баллом студента за год: чем выше оценка за экзамен, тем выше и годовой балл. Остается только гадать, это студенты с высокой успеваемостью показывают хорошие результаты по всем направлениям, включая травологию (что, конечно логичнее всего, но скучно). Или это студенты со склонностью к изучению растений, уходу за ними, и прочих умиротворяющих и кропотливых занятиях, с этим связанных, демонстрируют большую усидчивость, терпеливость, а главное, спокойный и неконфликтный характер и высокую дисциплину, что отражается на общей годовой оценке. Довольно сложно попадать в неприятности и получать за это штрафные баллы, когда проводишь свое время в мирном копании в грядках.

> Результат: 1 б.

> Комментарии:

-   Отличная работа! Да, запись повторяющихся эстетик в шапку -- то, что позволяет записать код более экономно.

-   Действительно, оценить направление связи только по статистическим данным проблематично, особенно с учетом потенциальных конфаундеров, которые вы описываете. Если же гипотетически рассматривать две эти переменные в вакууме, то стоит помнить, что баллы набираются в течение всего года, а оценка за экзамен проставляется в самом конце, поэтому, оценка за экзамен напрямую на набранные ранее баллы повлиять уже не может, а для обратного соображения возможности не исключены.

#### Второй скаттерплот

Отобразите на одной иллюстрации скаттерплоты, аналогичные тому, что вы делали на первом задании, для экзаменов по травологии, магловедению, прорицаниям и зельеварению. На иллюстрации также должна присутствовать линия тренда с характеристиками, аналогичными тем, что были в пункте 1. Раскрасьте точки в разные цвета, в соответствии с факультетами. Используйте стандартные цвета факультетов (как в лекционных rmd). Проинтерпретируйте полученный результат.

```{r}
theme_custom_2 <- theme(
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    strip.text = element_text(size = 20),
    axis.text = element_text(size = 15),
    axis.title = element_text(size = 17),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 18)
  )

scatterplot_1 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Herbology exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 3, stroke = 1,  position = position_jitter(width = 2, height = 2))+
  geom_smooth(se = FALSE,
              color = "red",
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5)+
  scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"),
                    guide = guide_legend(override.aes = list(size = 5, alpha = 1)))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
  theme_custom_2

scatterplot_2 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Muggle studies exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 3, stroke = 1,  position = position_jitter(width = 2, height = 2))+
  geom_smooth(se = FALSE,
              color = "red",
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5)+
  scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
  theme_custom_2

scatterplot_3 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Charms exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 3, stroke = 1,  position = position_jitter(width = 2, height = 2))+
  geom_smooth(se = FALSE,
              color = "red",
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5)+
  scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
  theme_custom_2

scatterplot_4 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Potions exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 3, stroke = 1)+
  geom_smooth(se = FALSE,
              color = "red",
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5)+
  xlab(label = "Year_score")+
 scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme_custom_2


ggarrange(plotlist = list(scatterplot_1, scatterplot_2, scatterplot_3, scatterplot_4), nrow = 4, common.legend = TRUE, heights = c(1, 1, 1, 1.2))
```

Интерпретация. Похоже на то, что по результатам всех экзаменов, кроме зельеварения, их оценка положительно скоррелирована с годовым баллом. Это кажется логичным - отличники успевают по всем предметам, и зарабатывают много очков в течение года, и наоборот. Экзамен по зельеварению единственный выбивается из этой картины, да и расположение точек - цветов факультета наводит на определенные мысли. Выделим-ка мы линии тренда отдельно для каждого факультета. В результате получается что-то вроде:

> Результат: 2 б.

> Комментарии:

-   Хоршошие графики, абсолютно точная интерпретация. Ниже пара комментариев.

-   В ситуации со скаттерплотами мне кажется более подходящей компоновка 2x2 -- при текущем подходе слишком сжимается ось ординат и разброс баллов сильно менее заметен.

-   Способ на дополнительные полбалла более экономичен с точки зрения кода: в нем используются фасеты (способ создать субграфики не прибегая к средствам из дополнительных пакетов), а исходно можно применить `pivot_longer()`, чтобы представить разные экзамены, как категории одной факторной переменной.

```{r fig.width=3, fig.height=3}
hogwarts |> 
  select(result, house, `Herbology exam`, `Muggle studies exam`, `Potions exam`, `Divinations exam`) |> 
  pivot_longer(-c(result, house), names_to = "exam", values_to = "mark") |> 
  ggplot() # Код графика
```

-   Альтернативный подход, чтобы избежать дублирования кода -- использование функций для создания графиков.

#### Третий скаттерплот

Видоизмените график, полученный на предыдущем шаге. Сгруппируйте и покрасьте линии тренда в соответствии с одной из категориальных переменных (с такой, которая подсвечивает одно из наблюдений на предыдущем этапе, относящееся ко всем 4-м экзаменам). Постарайтесь избежать коллизий в легенде, при этом сохранив и цветовую палитру для раскраски точек по факультетам.

```{r}

scatterplot_5 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Herbology exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 2, stroke = 1, alpha = 0.7, position = position_jitter(width = 2, height = 2))+
  geom_smooth(aes(color = house),
              se = FALSE,
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5, show.legend = FALSE)+
   scale_color_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"),
                     guide = guide_legend(override.aes = list(size = 5, alpha = 1)))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
  theme_custom_2

scatterplot_6 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Muggle studies exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 2, stroke = 1, alpha = 0.7, position = position_jitter(width = 2, height = 2))+
  geom_smooth(aes(color = house),
               se = FALSE,
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5, show.legend = FALSE)+
   scale_color_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
  theme_custom_2

scatterplot_7 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Charms exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 2, stroke = 1, alpha = 0.7, position = position_jitter(width = 2, height = 2))+
  geom_smooth(aes(color = house),
              se = FALSE,
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5, show.legend = FALSE)+
  scale_color_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
  scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme_custom_2

scatterplot_8 <- hogwarts |> 
  ggplot(aes(x = `result`, 
                 y = `Potions exam`))+
  geom_point(aes(fill = house), shape = 21, 
             size = 2, stroke = 1, alpha = 0.7)+
  geom_smooth(aes(color = house),
              se = FALSE,
              method = "lm",
              linetype = "dashed", 
              linewidth = 2.5, show.legend = FALSE)+
   scale_color_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  xlab(label = "Year_score")+
 scale_fill_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  theme_custom_2


ggarrange(plotlist = list(scatterplot_5, scatterplot_6, scatterplot_7, scatterplot_8), nrow = 4, common.legend = TRUE, heights = c(1, 1, 1, 1.2))

```

Интерпретация. Подозрения подтвердились - если по остальным предметам оценки студентов всех факультетов одинаково положительно скоррелированы с годовым баллом, то по зельеварению только студенты факультета Слизерин получают стабильно высокий балл, вне зависимости от годовой оценки, в то время, как все остальные факультеты получают балл стабильно низкий, опять же вне зависимости от годового балла. Обращает на себя внимание и то, что экстремально низкие значения набранных баллов за год показывают также исключительно студенты факультета Слизерин. Судя по всему, настало время пригласить на воспитательную беседу декана факультета Слизерин (он же профессор зельеварения), и заняться подробнее вопросом, как построено обучение, система мотиваций за достижения и санкций за нарушения порядка и учебного процесса на факультете Слизерин.

> Результат: 0.75 б.

> Комментарии:

-   Во-первых, не могу не отметить хорошее решение по одновременному сохранению цветовой гаммы точек и раскрашиванию линий тренда. Именно такой вариант и подразумевался в задании, отличная реализация!

-   Но вот выделено было не совсем то, что задумано. Линии тренда для каждого факультета -- это неплохой подход, но в некотором смысле дублирующий уже имеющуюся информацию. К тому же, он не вполне удовлетворяет условию `одно из наблюдений на предыдущем этапе, относящееся ко всем 4-м экзаменам`. Здесь имелось в виду довольно характерное бимодальное распределение студентов факультета Слизерин -- есть группа студентов с высоким итоговым баллом, и их антагонисты с низким (что вы абсолютно верно подметили), причем в 3-х из 4-х случаев их оценка за экзамен совпадает с общим трендом. Студенты на других факультетах не имеют такой широкой пропасти между теми, кто набрал много, и набрал мало. Дальше можно было бы поперебирать разные категориальные переменные, и посмотреть, что получается. В теории мы могли бы прийти к результату, когда на каждом графике имеется 2 линии тренда: одна для мальчиков, и одна для девочек.

### Столбчатые диаграммы

#### Первый барплот

Постройте барплот (столбиковую диаграмму) распределения набранных баллов за первый семестр (с 1-й по 17-ю неделю включительно) у студентов разного происхождения. Если у вас возникают трудности, можете обратиться к шпаргалке по dplyr от posit. Выдвиньте гипотезу (или гипотезы), почему распределение получилось именно таким.

```{r}

semester_scores <- hogwarts |> 
  group_by(bloodStatus) |>
  summarise(
    first_semester_score = sum(c_across(week_1:week_17))
  )

barplot_1 <- ggplot(semester_scores) +
  geom_col(aes(x = fct_reorder(bloodStatus, first_semester_score, .desc = TRUE),
               y = first_semester_score,
               fill = bloodStatus))+
  scale_fill_manual(values = c("half-blood" = "#C50000", 
                             "muggle-born" = "#ECB939", 
                             "pure-blood" = "#41A6D9"))+
   xlab(label = "bloodStatus")+
  theme_custom

barplot_1

```

Интерпретация. Самый высокий результат за первый семестр обучения продемонстрировали студенты со статусом "полукровок", самый низкий - со статусом "маглорожденных", "чистокровные" продемонстрировали средний результат. Если забыть об общем числе студентов с тем или иным происхождением, то можно предположить, что "полукровки" знают об своем дискриминизированном положении, и проявляют особое старание в учебе, чтобы укрепить свое положение в сообществе, в то время как "чистокровные" ощущают себя в привилегированном статусе и особого усердия не проявляют. Невысокие успехи "маглорожденных" в первом семестре, вероятно, связаны с тем, что эта категория студентов впервые столкнулась с миром волшебников и магии с поступлением в школу Хогвартс, и им нужно больше времени и на адаптацию в начале обучения, и на возвращение к реалиям школы магии и волшебства после каникул, проведенных в мире маглов.

Более банальное объяснение результатов - полукровок в школе просто больше всего, а маглорожденных - меньше всего, чем и объясняется соответствующий пропорционально вклад каждой из этих групп в колчество набранных баллов.

> Результат: 1 б.

> Комментарии:

-   Отличный график, интересные гипотезы. Я бы отдал предпочтение второй, но если бы картина была аналогичной при более равном количественном распределении студентов по этим категориям, вариант 1 тоже звучит очень правдоподобно.

-   Отдельно отмечу емкость кода для каждого отдельного графика в этом и каждом из предыдущих случаев. Тот случай, когда читаются легко и приятно не только текст и графики, но и код.

-   Несколько предостерег бы использовать точно те же цвета, что и на предыдущих графиках для обозначения иных групп. И в целом в данном случае столбики можно было покрасить монохромно, поскольку визуально они достаточно отделены друг от друга.

#### Второй барплот

Модифицируйте предыдущий график – отсортируйте столбцы в порядке убывания суммы баллов. Добавьте на график текстовые метки, отражающие число студентов каждого происхождения. Попробуйте использовать для этой задачи не geom_text, а geom_label. Настройте внешний вид geom_label по своему усмотрению. Поправьте название оси. Проинтерпретируйте график. Соотносится ли интерпретация с вашей гипотезой из пункта 1?

```{r}

students_status <- hogwarts |> 
  group_by(bloodStatus) |>
  summarise(count = n())


barplot_2 <- barplot_1 +
  geom_label(data = students_status, aes(x = bloodStatus, y = 1000, label = paste0(count, " students"), fill = NULL), color = "black", size = 8)+
  guides(fill = guide_legend(override.aes = list(label = "")))

barplot_2

```

Интерпретация. Количество набранных баллов за семестр (любой) напрямую связано с количеством студентов в той или иной категории происхождения, а не с самой категорией. Где больше студентов - там и больше набранных баллов. Интерпретация соотносится со вторым, скучным объяснением графика из пункта 1.

> Результат: 1 б.

> Комментарии:

-   Хороший результат. Ремарка по поводу альтернативного способа удаления буквы "a" с легенды -- - можно присвоить в `geom_label()` `show_guide = FALSE`.

#### Третий барплот

И снова измените график – добавьте на него разбивку не только по происхождению, но и по полу. Раскрасьте столбцы по происхождению. Сделайте подписи к столбцам читаемыми. Дайте графику название,измените, если требуется,название осей. Сделайте шаг для оси, на которой отображены очки, через каждую тысячу баллов. Разместите текстовые метки по правому краю графика. Настройте график таким образом, чтобы метки были видны целиком и не обрезались. Сохраните график на устройство.

```{r}
semester_scores_2 <- hogwarts |> 
  group_by(bloodStatus, sex) |>
  summarise(first_semester_score = sum(c_across(week_1:week_17)))|>
    mutate(`bloodStatus and sex` = paste0(bloodStatus, " & ", sex))
  



barplot_3 <- ggplot(semester_scores_2)+
  geom_col(aes(y = fct_reorder(`bloodStatus and sex`, first_semester_score, .desc = FALSE), 
               x = first_semester_score,
               fill = bloodStatus))+
  labs(title = "Распределение баллов за первый семестр\nв зависимости от происхождения и пола",
       x = "Баллы за первый семестр",
       y = "Происхождение и пол",
       fill = "Происхождение")+
  scale_fill_manual(labels = c("half-blood" = "Полукровка",
                               "muggle-born" = "Маглорожденный",
                               "pure-blood" = "Чистокровный"),
                    values = c("half-blood" = "#C50000", 
                             "muggle-born" = "#ECB939", 
                             "pure-blood" = "#41A6D9")

                    )+
  scale_x_continuous(limits = c(-50, 11000), breaks = seq(0, 8000, by = 1000))+
   geom_text(aes(y = fct_reorder(`bloodStatus and sex`, first_semester_score, .desc = FALSE), 
               x = first_semester_score,
               label = paste0(first_semester_score, " points")),
            colour = "black",
            size = 8,
            hjust = -0.05)+
  theme_custom

barplot_3

ggsave("bloodStatusAndSexSumPoints.png", barplot_3, width = 20, height = 15, dpi = 300, units = "in")
```

> Результат: 1.5 б.

> Комментарии:

-   Хорошая работа. Я бы оставил данные на метках аналогичными предыдущему случаю (где вы отобразили на них количество студентов каждой категории). На этом графике такое отображение... скажем так, наводило бы на определенные мысли.

-   Стилистический комментарий: понятно, что в реальном графике такое случится вряд ли, но в целом стоит приводить текстовые пометки на графике к единому языку: либо к русскому, как в предшествующих работах, либо оставлять английское написание.

#### Функция coord_flip

Функция coord_flip() из ggplot2 используется для перестановки осей координат графика. Она особенно полезна, когда нужно изменить ориентацию графика с горизонтальной (landscape) на вертикальную (portrait), или наоборот.

Плюсы:

Простота использования: функция требует минимального количества кода для перестановки осей. Удобство восприятия: иногда вертикальная ориентация графика делает его более удобным для чтения, особенно если данных много и требуется компактность. Например, если данные представляют собой набор временных рядов, удобно видеть годы вдоль оси X, а значения вдоль оси Y. Соответствие стандартам: во многих научных публикациях принято использовать определенные форматы графиков, и coord_flip() помогает быстро адаптировать графики под эти требования. Оптимизация пространства: в некоторых случаях, изменение ориентации графика может позволить уместить больше информации на нем.

Минусы:

Необходимость модификации кода: иногда приходится дополнительно менять атрибуты графика (например, метки осей), чтобы они правильно отображались после перестановки осей. Проблемы с размерами: если не учитывать размеры шрифтов и меток при перестановке, могут возникнуть проблемы с читаемостью или масштабированием. Совместимость с другими функциями: некоторые элементы могут работать некорректно при перестановке осей, что потребует дополнительных настроек. Для "сложносочиненных" графиков может совсем не подойти.

В целом, coord_flip() является полезной функцией для создания разнообразных графиков и адаптации их под различные требования.

```{r}
#Пример использования coord_flip()

scatterplot_0

scatterplot_flip <- scatterplot_0 + coord_flip()

scatterplot_flip
```

> Результат: 0.5 б.

> Комментарии:

-   Все супер! А еще после ее применения нужно постоянно держать в голове, что все, что мы делаем осью x (`scale_x_smth`, `aes(x = smth)`) будет отображено как y, и наоборот. Это может быть очень нетривиальным, несмотря на кажущуюся простоту. Поэтому `coord_flip()` лучше использовать в самом конце. Из плюсов -- некоторые графики по умолчанию можно разместить только с одним сочетанием осей x и y (например риджлайны из пакета `ggridges`). Если нам важно повернуть картинку на 90 градусов, то сработает только `coord_flip()`

-   Отдельно отмечу, что вы визуализируете даже те задания, которые по форме предполагают лишь текстовое рассуждения. Это очень здорово!

### Разное

#### Первый график

Сравните распределение баллов за экзамен по зельеварению и за экзамен по древним рунам. Сделайте это тремя разными способами. Под разными способами понимаются идеологически разные геомы или способы группировки. Не считаются разными способами изменения константных визуальных параметров (цвет заливки, размер фигур) на сходных в остальном графиках. Объедините графики, таким образом, чтобы результирующий график имел два столбца и 2 строки. Два графика должны находиться в верхней строке и занимать равную площадь. Третий график должен занимать нижнюю строку целиком.

```{r}

boxplot_exam <- hogwarts |> 
  select(id, `Study of ancient runes exam`, `Potions exam`) |> 
  pivot_longer(!id, 
               names_to = "exam", 
               values_to = "score") |> 
  ggplot(aes(x = exam, 
                   y = score,
                   fill = exam)) +
  geom_boxplot(notch = TRUE) +
  scale_fill_manual(name = "exam", values = c("Study of ancient runes exam" = "darkblue", "Potions exam" = "green"))+
   theme(legend.position = "none",
         axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  theme_custom

density_exam <- ggplot(hogwarts, aes(x = `Study of ancient runes exam`)) +
  geom_density(aes(fill = "Древние руны"), colour = "grey49", alpha = 0.5) +
  geom_density(aes(x = `Potions exam`, fill = "Зельеварение"), colour = "grey49", alpha = 0.5) +
  xlim(c(-30, 130)) +
  labs( x = "score", y = "density") +
  scale_fill_manual(name = "Предмет", values = c("Древние руны" = "darkblue", "Зельеварение" = "green")) +
  theme(legend.position = "none")+
  scale_y_continuous(position = "right")+
  theme_custom


violin_exam <- hogwarts |> 
  select(id, `Study of ancient runes exam`, `Potions exam`) |> 
  pivot_longer(!id, 
               names_to = "exam", 
               values_to = "score") |> 
  ggplot()+
  geom_violin(aes(x = exam, y = score, fill = exam))+
  labs(title = "Распределение баллов по экзаменам")+
  scale_fill_manual(name = "exam", values = c("Study of ancient runes exam" = "darkblue", "Potions exam" = "green"))+
  theme(legend.position = "bottom")+
  theme_custom

grid.arrange(arrangeGrob(boxplot_exam, density_exam, nrow = 1), violin_exam, nrow = 2)
```

> Результат: 2 б.

> Комментарии:

-   Мне все нравится. Это задание -- случай, когда модифицированный датасет все же стоит сохранить в переменную, потому что в дальнейшем (в этом же чанке) он переиспользуется еще раз.

#### Второй график

Визуализируйте средний балл по зельеварению студентов с различным происхождением. Вы вольны добавить дополнительные детали и информацию на график. Проинтерпретируйте результат. Как вы думаете,почему он именно такой? Если у вас есть гипотеза, проиллюстрируйте ее еще одним графиком (или графиками). Объедините их при помощи ggarrange. Измените порядок ваших фигур на первом графике слева направо следующим образом: маглорожденные,, чистокровные, полукровки. Скорректируйте название оси.

```{r}
statusPotionsExam <- hogwarts |> 
  group_by(bloodStatus) |> 
  summarise(meanPotionsExam = mean(`Potions exam`) |> round(2),
            Min = (min(`Potions exam`) |> round(2)),
            Max = (max(`Potions exam`) |> round(2)))
  

my_order <- c("muggle-born", "pure-blood", "half-blood")


statusPotionplot <- ggplot(statusPotionsExam , aes(x = factor(bloodStatus, levels = my_order), 
               y = meanPotionsExam))+
  geom_pointrange(aes(ymin = Min,
                      ymax = Max, 
                    colour = bloodStatus),
                linewidth = 2,
                fatten = 10)+
  labs(title = "Potions exam mean score")+
  scale_color_manual(values = c("muggle-born" = "black",
                               "pure-blood" = "deeppink",
                               "half-blood" = "chocolate"))+ 
  ylim(0, 100)+
  xlab(label = "bloodStatus")+
  theme_custom

statusPotionsExam_house <- hogwarts |> 
  group_by(bloodStatus, house) |> 
  summarise(meanPotionsExam = mean(`Potions exam`) |> round(2),
            Min = (min(`Potions exam`) |> round(2)),
            Max = (max(`Potions exam`) |> round(2)))


statusPotionplot_house <- ggplot(statusPotionsExam_house , aes(x = fct_reorder(house, meanPotionsExam, .desc = TRUE),
               y = meanPotionsExam, fill = house))+
  geom_pointrange(aes(ymin = Min,
                      ymax = Max, 
                    colour = house),
                linewidth = 2,
                fatten = 10)+
  ylim(0, 100)+
   scale_color_manual(values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25"))+
  xlab(label = "house")+
  facet_wrap(~ bloodStatus)+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  theme_custom

ggarrange(plotlist = list(statusPotionplot, statusPotionplot_house), nrow = 2, heights = c(1,2))
```

Интерпретация. Первый график: особой разницы в среднем баллле по зельеварению в зависимости от происхождения студентов не наблюдается. Более того, по всем трем категориям он довольно низкий. Гипотеза: профессор зельеварения, он же декан факультета Слизерин, ненавидит всех студентов одинаково, вне зависимости от их происхождения. Исключение - студенты факультета Слизерин.

Второй график: что и требовалось доказать. Ну, хотя-бы в сегрегации по признаку происхождения профессора зельеварения обвинить нельзя, спасибо и на этом.

> Результат: 2 б.

> Комментарии:

-   Отличная работа! Да, все именно так. Единственное -- не всегда размах выглядит самой оптимальной из мер дисперсии (хотя на втором графике он действительно выглядит "говорящим"), и всегда стоит указывать, какую именно из этих мер вы использовали при отображении (потому что чисто технически это могут быть доверительный интервал, стандартное отклонение, стандартная ошибка среднего, межквартильный интервал и т.д.)

### Воспроизведение графика

```{r}

theme_custom_3 <- theme(
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 18, hjust = 0.5),
    strip.text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 25),
    legend.title = element_text(size = 25),
    legend.text = element_text(size = 20)
  )

hogwarts_modified <- hogwarts %>% 
  mutate(
    mean_all_exams = rowMeans(.[, 8:20], na.rm = TRUE), 
    sex = factor(sex, levels = c("female", "male"), labels = c("Девочки", "Мальчики")) 
  ) 


ggplot(hogwarts_modified) +
  geom_violin(aes(x = house, y = `result`, fill = house )) +
  geom_boxplot(aes(x = house, y = `result`, fill = house), width = 0.1, outlier.colour = "black", outlier.shape = 16, fill = "white") + 
   geom_point(aes(x = house, y = mean_all_exams, color = house), 
             stat = "summary", 
             fun = "mean", 
             shape = 23,
             stroke = 2,
             color = "black", 
             size = 8,
             fill = "darkred")+ 
 scale_fill_manual(labels = c("Gryffindor" = "Гриффиндор", 
                             "Hufflepuff" = "Пуффендуй", 
                             "Ravenclaw" = "Когтевран", 
                             "Slytherin" = "Слизерин"),
                    values = c("Gryffindor" = "#C50000", 
                             "Hufflepuff" = "#ECB939", 
                             "Ravenclaw" = "#41A6D9", 
                             "Slytherin" = "#1F5D25")
                    )+
  facet_wrap(~ sex) +
  scale_y_continuous(limits = c(-300, 250), breaks = seq(-300, 250, by = 50))+
  geom_hline(yintercept = 0, linetype = "dashed", color = "#FF3366", size = 1.5)+
  labs(title = "Баллы студентов Хогвартса",
       subtitle = "Распределение числа баллов у студентов различных факультетов Хогвартса в 2023-2024 учебном году",
       y = "Количество очков",
       fill = "Факультет",
       caption = "Источник нездоровая фантазия автора лекции")+
  theme(plot.subtitle = element_text(color = "#663300"),
         axis.text.x = element_blank(), 
    axis.ticks.x = element_blank(), 
    axis.title.x = element_blank(),
    legend.position = "bottom",
    legend.direction = "vertical",
    legend.justification = "center"
  )+
  theme_custom_3
  



```

Интерпретация. Студенты факультета Когтевран, как девочки, так и мальчики, набирают большее количество баллов за год, чем студенты факультетов Гриффиндор и Пуффендуй, что в целом соотносится с их имиджем "заучек". Но при этом средний балл, полученный на экзаменах, вообще у всех примерно одинаковый! Даже у факультета Пуффендуй, что говорит о том, что мы их недооцениваем. Кроме факультета Слизерин, мальчики и девочки с одного и того же факультета показывают схожие результаты (и по набранным баллам, и по результатам экзаменов). Выбивается из этого ряда только факультет Слизерин - девочки из Слизерина показывают результаты на уровне девочек из Когтеврана, в то время как мальчики из Слизерина показывают вообще худший результат из всех: единственные, где вообще никто не справляется с тем, чтобы набрать положительную сумму баллов за год (средний балл за экзамены у них при этом незначительно ниже остальных факультетов, он хотя-бы положительный). Выше мы давали рекомендации провести проверку, как построено обучение и контроль дисциплины на факультете Слизерин. Уточнение к рекомендациям: именно у мальчиков с факультета Слизерин. Возможно, на факультете имеется некий лидер мужского пола, оказывающий сильное и в то же время отрицательное влияние на остальных мальчиков.

\*Я понимаю, что в исходном графике красным ромбом обозначен какой-то другой показатель, но я не смогла его подобрать, а отображение на данном графике среднего балла за все экзамены мне показалось интереснее и логичнее всего.

> Результат: 3.65

> Комментарии:

| Название блока                                         | Детальное описание                                                                                                                                                                                                                                                 | Балл за блок | Наличие         | Комментарий                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Результат |
|-------|-------|-------|-------|------------------------------------|-------|
| Общая структура графика                                | Виолин-плот с разбиением по факультетам с выделением цветов, фасетирование по полу                                                                                                                                                                                 | 0.5          | В полном объеме |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 0.5       |
| Кегль шрифта                                           | Точное соответствие не требуется, ожидается, что шрифт будет достаточно крупным, и будут сохранены “ранговые соотношения” между шрифтами. Заголовок – 32, Ось Y – 29, плашки фасетов и легенда – 25, подзаголовок и метки на осях – 20. Подпись – дефолтный кегль. | 0.5          | В полном объеме | Все отлично, название оси y показалось маловатым в выбранных пропорциях.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 0.4       |
| Прочие настройки темы.                                 | Добавление белого фона, расположение легенды, использование курсива, цветов шрифта, выравнивание заголовка и подзаголовка по центру. Выбор шрифта Times New Roman.                                                                                                 | 0.5          | Частично        | Отличная работа. Пара визуальных отличий – шрифт без засечек (не обязательно TNR, можно было использовать любой схожий); отсутствия курсива при описании меток легенды.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 0.3       |
| Текстовые элементы                                     | Настройка подписей осей, наличие заголовка, подзаголовка и подписи                                                                                                                                                                                                 | 0.5          | В полном объеме |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 0.5       |
| Цветовая гамма и метки на осях соответствуют референсу |                                                                                                                                                                                                                                                                    | 0.25         | В полном объеме |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 0.25      |
| Настройка подписей фасетов                             | Предполагалось использование функции labeller(). Материал выходит за рамки пройденного на лекциях.                                                                                                                                                                 | 0.25         | В полном объеме | Переименование в исходных данных – тоже рабочий вариант. Но советую `labeller()` тоже попробовать, хотя бы эксперимента ради.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 0.25      |
| Добавление боксплотов поверх geom_violin               |                                                                                                                                                                                                                                                                    | 0.25         | В полном объеме |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 0.25      |
| Средние значения                                       | Средний балл за весь год для каждого факультета без разбиения по полу. Оформление средних в виде ромба крупного размера (10) коричневого цвета с черным контуром.                                                                                                  | 0.25         | Частично        | Интересная дополнительная гипотеза. При ее визуализации есть одна проблема: имеющаяся ось y для нее не великовата, поэтому (с учетом размера точки) все значения получатся визуально сходными, даже если на самом деле таковыми не являются. Также, старайтесь максимально избегать каких-либо манипуляций, привязанных к **номеру** столбца. Эта процедура намного более рискованная чем кажется. Возможно, в следующий раз вы захотите на каком-то этапе анализа добавить в датасет новую переменную, или вам придут данные из того же источника, но с иным порядком колонок. Результат может быть непредсказуемым. Возвращаясь к ситуации с искомой метрикой – это средний балл за год по факультету. На графике в таком формате видно, что он довольно близок к медиане даже с фасетированием, кроме уже упомянутой ситуации на Слизерине. | 0.10      |
| Горизонтальная линия                                   | Пунктир, размер (2), лососевый цвет.                                                                                                                                                                                                                               | 0.25         | В полном объеме |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 0.25      |
| Размер графика                                         | Точного соответствия не предполагается. Ожидается график размера большего, чем дефолтный, элементы на котором не будут выглядеть слишком мелкими. Исходный размер – 16:10                                                                                          | 0.25         | В полном объеме |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 0.25      |
| Интерпретация                                          | Если кратко: когтевранцы набирают больше всех баллов, у слизеринцев бимодальное распределение. Бимодальность проявляется в полярных отметках юношей и девушек. Если указано, что как раз для таких случаев средние не очень показательны – замечательно.           | 0.5          | В полном объеме | Все очень здорово, единственная придирка будет к этому месту в тексте, касающемуся экзаменов у слизеринских мальчиков: “средний балл за экзамены у них при этом незначительно ниже остальных факультетов, он хотя-бы положительный”. Так как балл за экзамен может принимать значения от 0 до 100, быть неположительным он может лишь в ситуации, когда средний балл равен нулю, что не очень просто.                                                                                                                                                                                                                                                                                                                                                                                                                                          | 0.5       |

> Итог: 10.75 + 0.5 + 0.5 + 3.65 = 15.4 б.

> Итоговый комментарий:

-   Прекрасная работа, очень корректная интерпретация и (не могу еще раз не отметить) код, хороший не только тем, что он работает, но и тем, что его легко читать. Отмечу, что второе задание я проверял с большей "душностью" и порой оставлял комментарии по мелким аспектам. Напоследок -- маленькая техническая деталь -- 3.65 балла за воспроизведенный график могут быть распределены любым образом между двумя заданиями по базовой визуализации. Если вы захотите как-то перераспределить баллы -- можете писать в гугл-классы или телеграм.
