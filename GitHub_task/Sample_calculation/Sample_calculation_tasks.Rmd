---
title: "Sample_calculation_tasks"
author: "NataliaLaskina"
date: "2024-12-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(reprex)
library(rpact)

```

#1 задача

Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1 визите. Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3 месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей эффективности – 2 %.

################################################################################

Статистическая гипотеза не меньшей эффективности препарата в исследовании была сформулирована следующим образом:

H0: mT – mR ≤ δ
HA: mT – mR > δ

Где mT – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии у исследуемого препарата, в сравнении со значениями на 1 визите, mR – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии у референсного препарата, в сравнении со значениями на 1 визите. δ – граница не меньшей эффективности (-2%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет равномерным в соотношении 1:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величинаcошибки II рода (β) = 0.2;
4. На основании литературных данных мы ожидаем величину эффекта в группе
исследуемого препарата и в группе активного наблюдения (референсного препарата) на уровне в среднем (M±SD) 7.2 ± 3.1%.
5. Граница не меньшей эффективности исследуемого препарата по сравнению с референсным препаратом равна -2%.

Расчёт размера выборки был проведён в RStudio (2024-06-14 Build 18363) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1) и функции epi.ssninfc пакета EpiR (версия 2.0.78).

Результаты расчёта представлены далее.

```{r}

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 3.1,
    k = 1,
    delta = 0,
    margin = -2
)
```

H0: T – R ≤ -δ
HA: T – R > -δ
δ = 2

```{r}
epi.ssninfc(
    treat = 7.2,
    control = 7.2,
    delta = 2,
    sigma = 3.1,
    r = 1,
    n = NA,
    alpha = 0.025,
    power = 0.8
)
```

Таким образом, в каждую группу необходимо включить не менее 38 обследуемых, всего – 76 пациентов.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в каждую группу необходимо набрать не менее 48 человек. В скрининг (с учётом 10% выбывания) необходимо включить не менее 54 обследуемых в каждую группу.

###########################################################################

#2 задача

Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

################################################################################

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

H0: PT – PС ≤ δ
HA: PT – PС > δ

Где PT – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения в исследуемой группе, PС – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения в 
контрольной группе. δ – граница превосходства (1%).
При расчёте необходимого размера выборки были сделаны следующие допущения:
1. Распределение в группы будет в соотношении 2:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина
ошибки II рода (β) = 0.2;
4. На основании литературных данных мы ожидаем величину эффекта в группе
исследуемого препарата ~ 81% (PT) и в группе активного наблюдения на уровне ~ 66% (PC).
5. Граница превосходства препарата по сравнению с активным контролем равна 1%.

Расчёт размера выборки был проведён в RStudio (2024-06-14 Build 18363) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1) и функции epi.sssupb пакета EpiR (версия 2.0.78).

Результаты расчёта представлены далее.

```{r}

TwoSampleProportion.NIS(
alpha = 0.025,
beta = 0.2,
p1 = 0.81,
p2 = 0.66,
k = 2,
delta = 0.15,
margin = 0.01
)

```

```{r}

epi.sssupb(
    treat = 0.81,
    control = 0.66,
    delta = 0.01,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 2
)
```

Таким образом, в исследуемую группу необходимо включить не менее 242 обследуемых, в контрольную - не менее 121 исследуемых, всего – 363 пациента.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в исследуемую группу необходимо включить не менее 303 обследуемых, в контрольную - не менее 152 исследуемых. В скрининг (с учётом 10% выбывания) в исследуемую группу необходимо включить не менее 337 обследуемых, в контрольную - не менее 169 исследуемых.

###########################################################################

#3 задача

Исследование превосходства нового препарата А над препаратом Б в профилактике интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы препарат А получили 75% пациентов, включённых в исследование.

###########################################################################

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

H0: mT – mR ≥ δ
HA: mT – mR < δ

mT = 306 - 0.2*306 


Где mT – средний объём кровопотери при применении препарата A (исследуемого препарата), mR – средний объём кровопотери при применении препарата Б (референсного препарата). δ – граница превосходства (-50 мл).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет в соотношении 0.75:0.25;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;
4. На основании литературных данных известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б, т.е., на 61.2 мл., и средний объём кровопотери при применении препарата А составляет 244.8 ± 52 мл.

5. Граница превосходства препарата А по сравнению с препаратом Б равна -50 мл.

Расчёт размера выборки был проведён в RStudio (2024-06-14 Build 18363) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1) и функции epi.sssupc пакета EpiR (версия 2.0.78).

Результаты расчёта представлены далее.

```{r}

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 52,
    k = 3,
    delta = -61.2,
    margin = -50
)
```
HA: mR - mT > δ 
δ = 50  (переписано для применения функции epi.sssupc)
```{r}

epi.sssupc(
    treat = 306,
    control = 244.8,
    sigma = 52,
    delta = 50,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 0.3333    
)

```

Таким образом, в исследуемую группу необходимо включить не менее 677 обследуемых, в контрольную - не менее 226 исследуемых, всего – 903 пациента.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в исследуемую группу необходимо включить не менее 847 обследуемых, в контрольную - не менее 283 исследуемых. В скрининг (с учётом 10% выбывания) в исследуемую группу необходимо включить не менее 942 обследуемых, в контрольную - не менее 315 исследуемых.

###########################################################################

#4 задача

Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать снижение доли пациентов с рецидивом более, чем на 5%. При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на проведение исследования.

###########################################################################

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

H0: PT – PС ≥ δ 
HA: PT – PС < δ

Где PT – доля пациентов с рецидивом псориатического артрита за 6 месяцев на фоне лечения исследуемого препарата (y), PС – доля пациентов с рецидивом псориатического артрита за 6 месяцев на фоне лечения контрольным препаратом (x). δ – граница превосходства (-5%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет равномерным в соотношении 1:1;
2. Односторонняя величина ошибки I рода (α) составляет 0.025;
3. Мощность исследования будет определена рассчетами, так как нам известен необходимый размер выборки.
4. На основании литературных данных известно, на фоне лечения препаратом Х (контрольным) рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Ожидается, что препарат y (исследуемый) в среднем будет снижать частоту частоту рецидивов на 15% в сравнении с препаратом Х (контрольным).
5. Граница превосходства препарата y по сравнению с препаратом x равна -5%.
6. У спонсора имеется только 250 пачек препарата Х - мы ограничены таким количеством пациентов в контрольной группе. С учётом частоты выбывания пациентов в ходе исследования, равной 20% - остается 200 пациентов в контрольной группе.

Расчёт размера выборки был проведён в RStudio (2024-06-14 Build 18363) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1) и функции epi.sssupb пакета EpiR (версия 2.0.78).

Результаты расчёта представлены далее (подбирали нужное значение k, чтобы соблюсти ограничение в количестве человек в контрольной группе).

```{r}
?TwoSampleProportion.NIS
TwoSampleProportion.NIS(
alpha = 0.025,
beta = 0.2,
p1 = 0.17,
p2 = 0.32,
k = 4,
delta = -0.15,
margin = -0.05
)
```
HA: PС - PT > δ
δ = 5% (переписано для применения функции epi.sssupb)
```{r}

epi.sssupb(
    treat = 0.32,
    control = 0.17,
    delta = 0.05,
    alpha = 0.025,
    power = 0.8,
    r = 0.25,
    n = NA
)

```

Таким образом, в исследуемую группу необходимо включить не менее 794 обследуемых, в контрольную - не менее 199 исследуемых, всего – 993 пациента.
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в исследуемую группу необходимо включить не менее 993 обследуемых, в контрольную - не менее 248 исследуемых (что подходит под ограничение в количестве контрольного препарата - 250). В скрининг (с учётом 10% выбывания) в исследуемую группу необходимо включить не менее 1104 обследуемых, в контрольную - не менее 276 исследуемых (если я правильно понимаю, на этапе скрининга препараты участникам еще не назначаются).

################################################################################

Если я правильно поняла, то подгонять расчеты под заданный размер выборки некорректно. Или, если мы не подгоняем исследуемую группу. а задаем только контрольную, то это нормально? Если же я задаю размер выборки в функцию, и ставлю неизвестной мощность, мне выдается совершенно иное значение мощности, чем в расчете выше, где я задаю мощность и k, и получаю выборку. Не могу понять, как так получается, и как нужно вести расчеты "наоборот", от количества пациентов к мощности. 

```{r}

epi.sssupb(
    treat = 0.32,
    control = 0.17,
    delta = 0.05,
    alpha = 0.025,
    power = NA,
    r = 0.25,
    n = 993
)

```

