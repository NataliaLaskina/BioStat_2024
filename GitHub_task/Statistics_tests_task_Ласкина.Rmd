---
title: "Классические_статистические_тесты.ДЗ"
author: "Oleg Arnaut"
date: "2024-11-25"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(epitools)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


* Решение необходимо загружать в формате Rmd (воспроизводимый код).
** Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr
*** Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).


# Гипотеза 1. 

Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- c(rep("высокая", sample_size / 2), rep("низкая", sample_size / 2))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- c(
  rbinom(sample_size / 2, 1, 0.5), # Вероятность заболеть для активной группы
  rbinom(sample_size / 2, 1, 0.6)  # Вероятность заболеть для неактивной группы
)

# Объединение данных в датафрейм
df_activity_cardio <- data.frame(activity, cardio)

table(activity, cardio)
    
```

Если я правильно поняла, заданные вероятности (0.5 vs 0.6) при генерации данных - это теоретические параметры генеральной совокупности? А на конкретной выборке они могут отклоняться от теоретических значений из-за случайности выборки и приближаются к теоретическим значениям тем точнее, чем больше размер выборки. То есть, нам не нужно было добиваться точного соответствия заданным вероятностям, или это не верно? (этот вопрос касается и других гипотез, особенно там, где выборка маленькая).

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- c(rep("высокая", sample_size / 2), rep("низкая", sample_size / 2))
# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- c(
  rbinom(sample_size / 2, 1, 0.5), # Вероятность заболеть для активной группы
  rbinom(sample_size / 2, 1, 0.6)  # Вероятность заболеть для неактивной группы
)

# Объединение данных в датафрейм
df_activity_cardio_small <- data.frame(activity, cardio)

table(activity, cardio)
    
```


## Решение

H0: Между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет нет ассоциации.

H1: Между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет существует ассоциация.

α = 0.05

Критерий Chi squared для ассоциаций

Для определения критического значения нужно найти табличное значение критерия хи-квадрат с 1 степенью свободы (т.к. у нас две категории) при α = 0.05. Это значение равно 3.841

```{r}
#Расчеты для большой выборки

# Подсчитываем таблицу сопряженности 
mytable <- table(df_activity_cardio$activity, df_activity_cardio$cardio)

# Проводим тест хи-квадрат
chi_result <- chisq.test(mytable)

print(chi_result)

# Стандартизированные остатки
residuals <- chi_result$residuals

cat("\nСтандартизированные остатки:\n")
print(residuals)

# Отношение шансов и доверительный интервал
oddsratio(mytable)

```
X-squared = 0, df = 1, p-value = 1. Мы не можем отвергнуть нулевую гипотезу о том, что ассоциации между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет не существует. Наблюдаемые частоты в таблице сопряженности очень близки к тем, которые ожидались бы при отсутствии связи между переменными

Стандартизированные остатки: эти значения показывают, насколько наблюдаемые частоты в каждой ячейке таблицы отличаются от ожидаемых частот при условии, что переменные независимы. В данном случае, все остатки близки к 0, что согласуется с результатом хи-квадрат теста.

Практическая значимость: шансы заболеть в группе с низкой активностью в 1.088 раза выше, чем шансы заболеть в группе с высокой активностью. Доверительный интервал (0.479, 2.48) является очень широким и пересекает 1, что говорит о том, что это различие не является статистически значимым, практическая значимость в этом также вряд ли есть.

```{r}

#Повторение для маленькой выборки

# Подсчитываем таблицу сопряженности 
mytable_2 <- table(df_activity_cardio_small$activity, df_activity_cardio_small$cardio)

# Проводим тест хи-квадрат
chi_result_2 <- chisq.test(mytable_2)

print(chi_result_2)

#X-squared = 0.13889, df = 1, p-value = 0.7094 - также не можем отвергнуть нулевую гипотезу. Но: аппроксимация на основе хи-квадрат может быть неправильной. В таком случае лучше использовать метод Монте-Карло. 

print(chisq.test(mytable_2, simulate.p.value = TRUE, B = 10000)) 

#Без существенных изменений: X-squared = 0.55556, df = NA, p-value = 0.7068

#Cделаем еще тест Фишера:

print(fisher.test(mytable_2))


```

### Коммент Гипотеза 1. Необходимо поработать с генерацией данных. Ваши данные не соответствуют условиям задачи (соотношение случаев внутри и между группами, я вывел table). Это можно делать 'в лоб'
'Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1'
'У активных людей меньше вероятность заболеть (0.5 vs 0.6)'


# Гипотеза 2. 

Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <-  rnorm(sample_size, mean = 130, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 10)  # контрольная группа

# Объединение данных в датафрейм
df_bloodPressure <- data.frame(
  group = factor(c(rep("Новый метод", sample_size), rep("Стандартное лечение", sample_size))),
  pressure = c(group1, group2)
)

```

## Решение

H0: Среднее артериальное давление в группе с новым методом лечения и в группе со стандартным лечением равны.
H1: Среднее артериальное давление в группе с новым методом лечения меньше, чем в группе со стандартным лечением.
α = 0.05, квантили (0.05, 1)
Статистический тест: односторонний t-тест Уэлча, Z-критерий для разности средних
В данном случае односторонний тест является более подходящим выбором, потому что он учитывает направление ожидаемого эффекта от нового метода лечения (нам, согласно гипотезе, нужен левосторонний тест (давление в новом лечении меньше)).
Критическое значение: - 1.655

## Односторонний t-тест Уэлча

```{r}

# Критическое значение

sd(group1)
sd(group2)

sd_x = 10.7
nx   = 80
sd_y = 9.2
ny   = 80

# Степени свободы (Welch-Satterthwaite)
numerator <- ((sd_x^2 / nx) + (sd_y^2 / ny))^2
denominator <- (sd_x^4 / (nx^2 * (nx - 1))) + (sd_y^4 / (ny^2 * (ny - 1)))

df <- numerator / denominator

df

t_crit <- qt(0.05, df)
t_crit

#t-test
t_test_welch <- t.test(group1, group2, alternative = "less", var.equal = FALSE)


# Оценка практической значимости

mean_diff <- mean(df_bloodPressure$pressure[df_bloodPressure$group == "Новый метод"]) - mean(df_bloodPressure$pressure[df_bloodPressure$group == "Стандартное лечение"])

print(t_test_welch)
cat("Критическое значение:", t_crit, "\n")
cat("Наблюдаемое значение статистики t:", t_test_welch$statistic, "\n")
cat("P-значение:", t_test_welch$p.value, "\n")
cat("Разница средних значений:", mean_diff, "\n")

```

t = -2.3719, p-value = 0.009. 95 percent confidence interval: -Inf -1.134. Отвергаем нулевую гипотезу, артериальное давление в группе с новым методом лечения меньше, чем в группе со стандартным лечением.

Практическая значимость: среднее артериальное давление в группе, получающей новый метод лечения, на 3.75 мм рт. ст. ниже, чем среднее артериальное давление в группе, получающей стандартное лечение - это значение даже меньше стандартного отклонения, что вряд ли может говорить о клинической значимости.

Был рассчитан односторонний доверительный интервал, который оценивает только нижнюю границу разницы средних значений давления в двух группах (так как мы проверяем левостороннюю гипотезу). Нижняя граница доверительного интервала: -1.134. Это указывает на то, что средняя разница между группами с 95% вероятностью может быть любой величиной до этой границы включительно, наименьшая возможная разница составляет примерно -1.13 мм рт. ст. 
ДИ не включает ноль - это подтверждает, что существует статистически значимая разница между средним давлением в двух группах, подтверждаем альтернативную гипотезу о том, что новое лечение приводит к снижению среднего артериального давления. Но разница в среднем давлении хотя бы на уровне -1.13 мм рт. скорее оказывается незначительной с клинической точки зрения. 

### Коммент Гипотеза 2. Что касается выбора теста, односторонняя гипотеза правильный выбор. Но у нас большая выборка, ttest сработает, но есть альтернатива, а именно асимптотический тест. Что касается практической значимости, подумайте. При такой разнице средних и 95% ДИ наша разница скорее близка к погрешности измерения.

## Z-критерий для разности средних, левосторонний

```{r}

# Расчет средних и стандартных отклонений
mean1 <- mean(group1)
sd1 <- sd(group1)
n1 <- length(group1)

mean2 <- mean(group2)
sd2 <- sd(group2)
n2 <- length(group2)

# Расчет стандартной ошибки разности средних
se_diff <- sqrt((sd1^2 / n1) + (sd2^2 / n2))

# Расчет z-статистики
z_stat <- (mean1 - mean2) / se_diff

# Расчет одностороннего p-значения
p_value <- pnorm(z_stat, lower.tail = TRUE)

# Оценка практической значимости
mean_diff <- mean1 - mean2


# Критическое значение z
alpha <- 0.05
z_crit <- qnorm(alpha)


# Расчет доверительного интервала (95% доверительный интервал)
confidence_level <- 0.95
z_critical_ci <- qnorm((1 + confidence_level) / 2) # Для двухстороннего интервала
margin_error <- z_critical_ci * se_diff
lower_ci <- mean_diff - margin_error
upper_ci <- mean_diff + margin_error

# Вывод результатов
cat("Критическое значение Z:", z_crit, "\n")
cat("Наблюдаемое значение статистики Z:", z_stat, "\n")
cat("P-значение:", p_value, "\n")
cat("Разница средних значений:", mean_diff, "\n")
cat("Доверительный интервал (95%): [", lower_ci, ", ", upper_ci, "]\n")
```

Мы отвергаем нулевую гипотезу, артериальное давление в группе с новым методом лечения меньше, чем в группе со стандартным лечением. Мы получили статистическую значимость, но не практическую: разница между средним артериальным давлением в группе с новым методом лечения и в группе со стандартным лечением всего 3.75 мм рт. ст., что даже меньше стандартного отклонения, такую разницу нельзя признать клинически значимой. 

Доверительный интервал в этом тесте для сравнения решено рассчитать двусторонний: он показывает диапазон, в котором с вероятностью 95% находится истинная разность средних, для общей оценки диапазона возможных значений разности средних значений артериального давления в двух группах. Мы получили интервал между -6.85 и -0.651 мм рт.ст., т.е., новое лечение, с 95% вероятностью, дает небольшой, клинически не значимый, но статистически значимый эффект снижения артериального давления. 

# Гипотеза 3. 

Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(n = sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(n = sample_size, size = 100, prob = 0.6)

# Создание датафрейма
df_activity  <- data.frame(before = before, after = after)

```

## Решение

H0: Средний уровень физической активности до и после проведенной реабилитации не отличаются. 
H1: Средний уровень физической активности после программа реабилитации больше, чем до него.
α = 0.05, квантили (0, 0.95)
Статистический тест: t-критерий для разницы средних, для зависимых выборок, правосторонний. Для зависимых, потому что, насколько я поняла, уровень физической активности измеряют на одних и тех же пациентах до и после реабилитации.Правосторонний - так как нам нужно оценить увеличени эффекта в большую сторону.
Критическое значение 1.699

```{r}

# Критическое значение
alpha <- 0.05
sample_size <- 30
critical_value <- qt(1 - alpha, df = sample_size - 1)
print(critical_value)

#t-test

paired_t_test <- t.test(df_activity$after, df_activity$before, alternative = "greater", paired = TRUE)


# Оценка практической значимости

mean_diff_2 <- mean(df_activity$after) - mean(df_activity$before)

print(paired_t_test)
cat("Критическое значение:", critical_value, "\n")
cat("Наблюдаемое значение статистики t:", paired_t_test$statistic, "\n")
cat("P-значение:", paired_t_test$p.value, "\n")
cat("Разница средних значений:", mean_diff_2, "\n")

```

t = 7.45, df = 29, p-value = 1.483e-08. 95 percent confidence interval: 8.014708-Inf. Доверительный интервал не включает ноль и p-value < 0.05: нулевую гипотезу отвергаем. Уровень физической активности после реабилитации вырос на 10 пунктов. Это может быть клинически значимо, если приводит к улучшению качества жизни или достижению терапевтических целей пациентов (нужно уточнить у клиницистов, соответствует ли изменение на 10 пунктов существенному улучшению способности к физической активности).
Верхняя граница доверительного интервала отсутствует, поскольку тест был односторонним, предполагая только увеличение активности. Нижняя граница доверительного интервала означает, что с вероятностью 95% минимальное увеличение физической активности (в среднем) после реабилитации составляет 8 баллов. Доверительный интервал и разница средних показывают, что реабилитация имеет положительный эффект на физическую активность пациентов.

### Коммент Гипотеза 3. Необходимо поработать с генерацией данных. Ваши данные не соответствуют условиям задачи поскольку шкала должна быть целым числом. Подумайте над аргументами функции что с чем сравнивают и что должно быть больше или меньше. Практическая значимость - тут правильно не только указать на 95%ДИ, но и порассуждать вокруг него.

# Гипотеза 4. 

Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rep(c("Новый метод", "Стандартное лечение"), each = sample_size/2)


# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- c(
  rbinom(sample_size/2, 1, 0.7),  # для нового метода
  rbinom(sample_size/2, 1, 0.65)  # для стандартного метода
)

df_infarct_activity <- data.frame(treatment, activity)
table(treatment, activity)
    
```

## Решение

H0: Доля пациентов, вернувшихся к нормальной физической активности после лечения новым методом и после стандартного лечения не отличаются.
H1: Доля пациентов, вернувшихся к нормальной физической активности после лечения новым методом больше, чем после стандартного лечения.

α = 0.05, квантили (0, 0.95)

Статистический тест: z-критерий для разности долей для независимых выборок, правосторонний (так как по гипотезе доля в группе с новым методом больше, чем в контрольной группе, это означает, что область критического значения лежит в правой части распределения).


```{r}
# Критическое значение Z-статистики (правосторонний тест)
alpha <- 0.05
critical_z_value <- qnorm(1 - alpha)

# Расчет статистических величин
new_method_success <- sum(activity[treatment == "Новый метод"])
standard_treatment_success <- sum(activity[treatment == "Стандартное лечение"])
n_new_method <- sum(treatment == "Новый метод")
n_standard_treatment <- sum(treatment == "Стандартное лечение")

p_new_method <- new_method_success / n_new_method
p_standard_treatment <- standard_treatment_success / n_standard_treatment

P <- (new_method_success + standard_treatment_success) / (n_new_method + n_standard_treatment) # объединенная доля

diff_proportions <- p_new_method - p_standard_treatment

SE <- sqrt(P * (1 - P) * (1/n_new_method + 1/n_standard_treatment)) 

#  Расчет Z-критерия
z_score <- diff_proportions / SE

p_value <- 1 - pnorm(z_score)

# Расчет 95% доверительного интервала для разности долей
# Для правостороннего теста используем одностороннюю границу
margin_error <- qnorm(0.95) * SE
ci_lower <- diff_proportions - margin_error
ci_upper <- Inf

# Расчет размера эффекта h Коэна
# h = 2 * arcsin(sqrt(p1)) - 2 * arcsin(sqrt(p2))
h_cohen <- 2 * (asin(sqrt(p_new_method)) - asin(sqrt(p_standard_treatment)))

cat("Z-статистика:", z_score, "\n")
cat("P-значение:", p_value, "\n")
cat("Критическое значение Z:", critical_z_value, "\n")
cat("Доля пациентов, вернувшихся к нормальной физической активности (Новый метод):", p_new_method, "\n")
cat("Доля пациентов, вернувшихся к нормальной физической активности (Стандартное лечение):", p_standard_treatment, "\n")
cat("Доверительный интервал (95%): [", ci_lower, ", ", ci_upper, "]\n")
cat("Размер эффекта h Коэна:", h_cohen, "\n")

# Практическая значимость (NNT - Number Needed to Treat)
NNT <- ceiling(1 / abs(diff_proportions))
cat("4. NNT (Number Needed to Treat):", NNT, "\n",
    "   Необходимо пролечить", NNT, "пациентов новым методом,\n",
    "   чтобы получить один дополнительный случай восстановления\n",
    "   нормальной физической активности\n")
```

Z-статистика: 0.734, P-значение: 0.231, критическое значение Z: 1.645. Доверительный интервал: [ -0.06198905 ,  Inf ] Доверительный интервал включает ноль - это согласуется с отсутствием статистически значимой разницы между методами. Мы не можем отвергнуть нулевую гипотезу. Нижняя граница доверительного интервала отрицательная (-0.062), что означает, что с 95% уверенностью мы не можем исключить возможность того, что стандартный метод может быть даже немного эффективнее нового (на 6.2 процентных пункта).
Размер эффекта h Коэна: 0.103915. Интерпретация: |h| < 0.2 - незначительный размер эффекта.Это указывает на то, что даже если разница между методами существует, она очень мала с практической точки зрения. 
NNT = 20 : необходимо пролечить 20 пациентов новым методом, чтобы получить один дополнительный случай успешного восстановления. Это довольно большое число, что ставит под сомнение практическую целесообразность внедрения нового метода.

На основании этих данных нельзя рекомендовать замену стандартного метода лечения новым. Возможно, стоит:
Провести дополнительное исследование с большей выборкой
Изучить подгруппы пациентов, где новый метод может быть более эффективен

### Коммент Гипотеза 4. Необходимо поработать с генерацией данных. Ваши данные не соответствуют условиям задачи (соотношение случаев внутри и между группами, я вывел table). Хотелось бы посмотреть на ваши рассуждения по-поводу практической значимости и возможные предложения в контексте данного исследования

# Гипотеза 5. 

Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

До медитации вероятность стресса 0.4 (40% людей имеют стресс)
После медитации общая вероятность стресса должна быть около 0.2 (20% людей имеют стресс)
Но поскольку это связанные выборки (одни и те же люди до и после), то состояние человека после медитации зависит от его исходного состояния. Поэтому мы используем условные вероятности. Эти условные вероятности (0.3 и 0.1) были выбраны так, чтобы:
Отразить положительный эффект медитации (вероятность избавиться от стресса 0.7 выше, чем вероятность его сохранить 0.3)
Учесть, что у людей без стресса он редко появляется после медитации (только 10%)
В итоге получить примерно заданную общую вероятность стресса после медитации (0.2 или 20%)

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
# Исходная вероятность стресса 0.4
before <- rbinom(sample_size, 1, 0.4)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)

# Вероятность стресса уменьшается до 0.2
# Но нужно учесть зависимость между измерениями
# Используем условную вероятность для создания реалистичной связи

# Создаем после-значения с учетом до-значений
after <- numeric(sample_size)
for(i in 1:sample_size) {
    if(before[i] == 1) {
        # Если был стресс, вероятность его сохранения 0.3
        after[i] <- rbinom(1, 1, 0.3)
    } else {
        # Если не было стресса, вероятность его появления 0.1
        after[i] <- rbinom(1, 1, 0.1)
    }
}

#Создание таблицы сопряженности:

table_stress_meditation <- table(before, after)

table_stress_meditation

```

## Решение

H0: Вероятность наличия стресса до медитации равна вероятности наличия стресса после медитации
H1: Вероятность наличия стресса до медитации не равна вероятности наличия стресса после медитации
α = 0.05
Статистический тест: тест МакНемара для связанных выборок
```{r}

# Тест МакНемара
mcnemar_test <- mcnemar.test(table_stress_meditation)
print("\nРезультаты теста МакНемара:")
print(mcnemar_test)

# Расчет процентных долей
prop_before <- mean(before)
prop_after <- mean(after)
prop_diff <- prop_before - prop_after

# Расчет доверительного интервала для разности пропорций
# Используем метод Agresti-Min для связанных выборок
n_11 <- sum(before == 1 & after == 1)  # остались со стрессом
n_10 <- sum(before == 1 & after == 0)  # избавились от стресса
n_01 <- sum(before == 0 & after == 1)  # появился стресс
n_00 <- sum(before == 0 & after == 0)  # не было стресса

# Стандартная ошибка для разности пропорций в связанных выборках
se <- sqrt((n_10 + n_01)/(sample_size^2))
ci_margin <- qnorm(0.975) * se
ci_lower <- prop_diff - ci_margin
ci_upper <- prop_diff + ci_margin

# Расчет размера эффекта (phi coefficient)
phi <- sqrt(mcnemar_test$statistic/sample_size)

# Расчет NNT (Number Needed to Treat)
nnt <- ceiling(1/abs(prop_diff))

# Вывод результатов
cat("\nАнализ эффективности медитации\n")
cat("============================\n")
cat("Доля лиц со стрессом до медитации:", round(prop_before * 100, 1), "%\n")
cat("Доля лиц со стрессом после медитации:", round(prop_after * 100, 1), "%\n")
cat("Разность долей (до - после):", round(prop_diff * 100, 1), 
    "процентных пунктов\n")
cat("95% доверительный интервал: [", 
    round(ci_lower * 100, 1), ", ", 
    round(ci_upper * 100, 1), "] процентных пунктов\n")
cat("Размер эффекта (phi):", round(phi, 3), "\n")
cat("NNT:", nnt, "(необходимо пролечить", nnt, 
    "пациентов для одного дополнительного случая избавления от стресса)\n\n")

# Анализ индивидуальных изменений
cat("Анализ индивидуальных изменений:\n")
cat("- Количество людей, у которых стресс исчез:", n_10, "\n")
cat("- Количество людей, у которых стресс появился:", n_01, "\n")
cat("- Количество людей без изменений:", n_11 + n_00, "\n")

```

χ² = 17.391, df = 1, p-value = 3.042e-05. Отвергаем нулевую гипотезу об отсутствии влияния медитации.

Размер эффекта (phi) = 0.59 - большой эффект.
NNT = 3 - очень хороший показатель (нужно пролечить всего 3 человека для получения одного положительного результата).

До медитации: 56% испытывали стресс (28 человек)
После медитации: 14% испытывали стресс (7 человек)
Снижение на 42 процентных пункта
95% доверительный интервал: [23.2%, 60.8%]

У 22 человек стресс исчез, только у 1 человека стресс появился.
У 27 человек состояние не изменилось (включая тех, у кого изначально не было стресса).

Медитация действительно оказывает статистически и практически значимое влияние на наличие стресса у лиц с высоким уровнем тревожности.

### Коммент Гипотеза 5. Необходимо поработать с генерацией данных. Ваши данные не соответствуют условиям задачи (соотношение случаев внутри, я вывел table 0.62 и 0.10 вместо требуемых 0.4 и 0.2). Подумайте над выбором теста - у нас повторные измерения, а binom.test не в состоянии измерить тех кто поменял свой статус в обе стороны, как это делает один из тестов который мы разбирали на занятии. В пункте с оценкой практической значимости необходимо также доработать. 

# Гипотеза 6. 

Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rbinom(sample_size, size = 100, prob = 0.55)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rbinom(sample_size, size = 100, prob = 0.68)  # контрольная группа

```

## Решение

H0: Средний уровень депрессии в группе с альтернативным методом лечения равен среднему уровню в группе со стандартным лечением. 

Н1: Средний уровень депрессии в группе с альтернативным методом лечения меньше, чем в группе со стандартным лечением.

α = 0.05, квантили (0.05, 1)

Статистический тест: U-критерий Манна-Уитни.Он подходит для сравнения двух независимых выборок и не требует предположений о нормальности распределения. Левосторонний тест (гипотеза о том, что в группе с новым лечением среднее меньше).

Табличное критическое значение 127

```{r}

print(wilcox.test_result <- wilcox.test(group1, group2, alternative = "less"))

mean_difference <- mean(group2) - mean(group1)

# Оценка размера эффекта (r Розенталя)
n1 <- length(group1)
n2 <- length(group2)
z <- qnorm(wilcox.test_result$p.value/2) # деление на 2 для двустороннего p-значения
r <- abs(z)/sqrt(n1 + n2)

# Доверительный интервал для r (через преобразование Фишера)
r_to_z <- function(r) 0.5 * log((1 + r)/(1 - r))
z_to_r <- function(z) (exp(2 * z) - 1)/(exp(2 * z) + 1)

z_r <- r_to_z(r)
se_z <- 1/sqrt(n1 + n2 - 3)
ci_z_lower <- z_r - 1.96 * se_z
ci_z_upper <- z_r + 1.96 * se_z

ci_r_lower <- z_to_r(ci_z_lower)
ci_r_upper <- z_to_r(ci_z_upper)

# Расчет вероятности превосходства (PS - Probability of Superiority)
# Число пар, где значение из группы 1 меньше значения из группы 2
pairs <- expand.grid(group1 = group1, group2 = group2)
favorable_pairs <- sum(pairs$group1 < pairs$group2)
total_pairs <- nrow(pairs)
ps <- favorable_pairs/total_pairs

cat("Наблюдаемое значение статистики (W):", wilcox.test_result$statistic, "\n")
cat("P-значение:", wilcox.test_result$p.value, "\n")
cat("Разница в средних значениях:", mean_difference, "\n")
cat("Размер эффекта (r Розенталя):", r, "\n")
cat("95% доверительный интервал для r: [", ci_r_lower, ", ", ci_r_upper, "]\n")
cat("Вероятность превосходства:", ps, "\n")


```

Отклоняем нулевую гипотезу, средний уровень депрессии в группе с альтернативным методом лечения меньше, чем в группе со стандартным лечением. 

Практическая значимость: разница между группами составляет 13 пунктов по шкале депрессии, что может быть клинически значимо, особенно если уменьшение уровня депрессии связано с улучшением состояния пациентов.

Размер эффекта r > 0.5 уже считается большим эффектом, полученный r = 0.84 значительно превышает этот порог, что подтверждает, что различие между группами существенное и клинически значимое.
95% доверительный интервал для r: [0.7100561 ,  0.9107221]  : нижняя граница (0.71) все равно показывает большой эффект; узкий интервал указывает на точность оценки; ДИ не включает 0, что подтверждает надежность эффекта.

Вероятность превосходства: 0.9775: в 97.75% случаев случайно выбранный пациент из экспериментальной группы имеет меньший уровень депрессии, чем случайно выбранный пациент из контрольной группы. Это очень высокий показатель.

Экспериментальный метод лечения показывает:

Статистически значимое преимущество (p < 0.001)
Клинически значимое улучшение (разница в 13 пунктов)
Очень большой и надежный размер эффекта (r = 0.84, 95% ДИ: [0.71; 0.91])
Высокую вероятность лучшего результата для пациентов (PS = 0.9775)
Все показатели согласованно указывают на существенное превосходство экспериментального метода лечения над стандартным.

### Коммент Гипотеза 6. Необходимо поработать с генерацией данных, не воспроизведены условия задачи. Подсказка - используйте функцию rbinom(). Рассуждения относительно практической значимости могут быть дополнены ДИ, мерой ассоциации, размера эффекта и т. д., в а также рассуждениями вокруг них в контексте исследования

# Гипотеза 7. 

Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

Н0: Корреляция между длительностью сна и уровнем стресса равна нулю.
Н1: Существует отрицательная корреляция между продолжительностью сна и уровнем стресса.
α=0.05, квантили (0.05, 1)
Статистический тест: тест на корреляцию Пирсона, односторонний (отрицательная корреляция).

```{r}

library(ggplot2)

print(correlation_test <- cor.test(df$HoursOfSleep, df$StressLevel, alternative = "l", method = "pearson"))

ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)+
  labs(x = "Длительность сна (часы)", y = "Уровень стресса") +
  ggtitle("Ассоциация между длительностью сна и уровнем стресса")+
  theme_bw()

cat("Наблюдаемый коэффициент корреляции (r):", cor(df$HoursOfSleep, df$StressLevel), "\n")
cat("P-значение:", correlation_test$p.value, "\n")

```

Нулевую гипотезу отвергаем.

Практическая значимость: p=-0.5222265, сила корреляции умеренная:  0.3≤∣ρ∣<0.7

### Коммент Гипотеза 7. -





