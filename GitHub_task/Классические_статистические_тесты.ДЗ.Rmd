---
title: "Классические_статистические_тесты.ДЗ"
author: "Oleg Arnaut"
date: "2024-11-25"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(epitools)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


* Решение необходимо загружать в формате Rmd (воспроизводимый код).
** Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr
*** Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).


# Гипотеза 1. 

Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("высокая", "низкая"), size = sample_size, replace = TRUE)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "высокая", 
                 rbinom(sample_size, 1, 0.5), 
                 rbinom(sample_size, 1, 0.6))

# Объединение данных в датафрейм
df_activity_cardio <- data.frame(activity, cardio)
    
```


```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("высокая", "низкая"), size = sample_size, replace = TRUE)
# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "высокая", 
                 rbinom(sample_size, 1, 0.5), 
                 rbinom(sample_size, 1, 0.6))

# Объединение данных в датафрейм
df_activity_cardio_small <- data.frame(activity, cardio)
    
```


## Решение

H0: Между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет нет ассоциации.

H1: Между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет существует ассоциация.

α = 0.05

Критерий Chi squared для ассоциаций

Для определения критического значения нужно найти табличное значение критерия хи-квадрат с 1 степенью свободы (т.к. у нас две категории) при α = 0.05. Это значение равно 3.841

```{r}
#Расчеты для большой выборки

# Подсчитываем таблицу сопряженности 
mytable <- table(df_activity_cardio$activity, df_activity_cardio$cardio)

# Проводим тест хи-квадрат
chi_result <- chisq.test(mytable)

print(chi_result)

# Стандартизированные остатки
residuals <- chi_result$residuals

cat("\nСтандартизированные остатки:\n")
print(residuals)

# Отношение шансов и доверительный интервал
oddsratio(mytable)

```
X-squared = 4.5523, df = 1, p-value = 0.03287. Мы отвергаем нулевую гипотезу, ассоциация между уровнем физической активности и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет существует.

Стандартизированный остаток для группы с высокой физической активностью и низкой частотой сердечно-сосудистых заболеваний равен 1.44, а для группы с низкой физической активностью и высокой частотой сердечно-сосудистых заболеваний он равен −1.27. Эти значения говорят о том, что низкая частота сердечно-сосудистых заболеваний среди людей с высокой физической активностью и высокая частота сердечно-сосудистых заболеваний среди людей с низкой физической активностью вносят наибольший вклад в наличие ассоциации по результатам теста (хотя различия между наблюдаемыми и ожидаемыми частотами и не столь существенны, так как остатки не превышают 2 по модулю).

Практическая значимость: у людей с низкой физической активностью шансы заболеть сердечно-сосудистыми заболеваниями примерно в 2.72 раза выше, чем у тех, кто ведет активный образ жизни. Это существенные отличия.

```{r}

#Повторение для маленькой выборки

# Подсчитываем таблицу сопряженности 
mytable_2 <- table(df_activity_cardio_small$activity, df_activity_cardio_small$cardio)

# Проводим тест хи-квадрат
chi_result_2 <- chisq.test(mytable_2)

print(chi_result_2)

#X-squared = 3.0613, df = 1, p-value = 0.08018 - не можем отвергнуть нулевую гипотезу. Но: аппроксимация на основе хи-квадрат может быть неправильной. В таком случае лучше использовать метод Монте-Карло. 

print(chisq.test(mytable_2, simulate.p.value = TRUE, B = 10000)) 

#Так уже получается получше: X-squared = 4.537, p-value = 0.05669

#Cделаем еще тест Фишера:

print(fisher.test(mytable_2))


```


# Гипотеза 2. 

Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <-  rnorm(sample_size, mean = 130, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 10)  # контрольная группа

# Объединение данных в датафрейм
df_bloodPressure <- data.frame(
  group = factor(c(rep("Новый метод", sample_size), rep("Стандартное лечение", sample_size))),
  pressure = c(group1, group2)
)

```

## Решение

H0: Среднее артериальное давление в группе с новым методом лечения и в группе со стандартным лечением равны.
H1: Среднее артериальное давление в группе с новым методом лечения меньше, чем в группе со стандартным лечением.
α = 0.05, квантили (0.05, 1)
Статистический тест: односторонний t-тест Уэлча.
В данном случае односторонний тест является более подходящим выбором, потому что он учитывает направление ожидаемого эффекта от нового метода лечения (нам, согласно гипотезе, нужен левосторонний тест (давление в новом лечении меньше)).
Критическое значение: - 1.655

```{r}

# Критическое значение

sd(group1)
sd(group2)

sd_x = 10.7
nx   = 80
sd_y = 9.2
ny   = 80

# Степени свободы (Welch-Satterthwaite)
numerator <- ((sd_x^2 / nx) + (sd_y^2 / ny))^2
denominator <- (sd_x^4 / (nx^2 * (nx - 1))) + (sd_y^4 / (ny^2 * (ny - 1)))

df <- numerator / denominator

df

t_crit <- qt(0.05, df)
t_crit

#t-test
t_test_welch <- t.test(group1, group2, alternative = "less", var.equal = FALSE)


# Оценка практической значимости

mean_diff <- mean(df_bloodPressure$pressure[df_bloodPressure$group == "Новый метод"]) - mean(df_bloodPressure$pressure[df_bloodPressure$group == "Стандартное лечение"])

print(t_test_welch)
cat("Критическое значение:", t_crit, "\n")
cat("Наблюдаемое значение статистики t:", t_test_welch$statistic, "\n")
cat("P-значение:", t_test_welch$p.value, "\n")
cat("Разница средних значений:", mean_diff, "\n")

```

t = -2.3719, p-value = 0.009. 95 percent confidence interval: -Inf -1.134. Отвергаем нулевую гипотезу, артериальное давление в группе с новым методом лечения меньше, чем в группе со стандартным лечением.

Практическая значимость: среднее артериальное давление в группе, получающей новый метод лечения, на 3.75 мм рт. ст. ниже, чем среднее артериальное давление в группе, получающей стандартное лечение. 

# Гипотеза 3. 

Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rnorm(sample_size, mean = 50, sd = 10)

# Генерация данных после реабилитации
after <- before + rnorm(sample_size, mean = 10, sd = 10)

df_activity <- data.frame(before, after)

```

## Решение

H0: Средний уровень физической активности до и после проведенной реабилитации не отличаются.
H1: Средний уровень физической активности после программа реабилитации больше, чем до него.
α = 0.05, квантили (0, 0.95)
Статистический тест: t-критерий для разницы средних, для зависимых выборок, правосторонний. Для зависимых, потому что, насколько я поняла, уровень физической активности измеряют на одних и тех же пациентах до и после реабилитации.Правосторонний - так как нам нужно оценить увеличени эффекта в большую сторону.
Критическое значение 1.699

```{r}

# Критическое значение
alpha <- 0.05
sample_size <- 30
critical_value <- qt(1 - alpha, df = sample_size - 1)
print(critical_value)

#t-test

paired_t_test <- t.test(df_activity$after, df_activity$before, alternative = "greater", paired = TRUE)


# Оценка практической значимости

mean_diff_2 <- mean(df_activity$after) - mean(df_activity$before)

print(paired_t_test)
cat("Критическое значение:", critical_value, "\n")
cat("Наблюдаемое значение статистики t:", paired_t_test$statistic, "\n")
cat("P-значение:", paired_t_test$p.value, "\n")
cat("Разница средних значений:", mean_diff_2, "\n")

```

t = 4.58, df = 29, p-value = 4.066e-05. 95 percent confidence interval: 5.523464-Inf. Нулевую гипотезу отвергаем. Уровень физической активности после реабилитации вырос на 9 пунктов.

# Гипотеза 4. 

Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- factor(sample(c("Новый метод", "Стандартное лечение"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5)))


# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- rbinom(sample_size, 1, prob = ifelse(treatment == "Новый метод", 0.7, 0.65))

df_infarct_activity <- data.frame(treatment, activity)
    
```

## Решение

H0: Доля пациентов, вернувшихся к нормальной физической активности после лечения новым методом и после стандартного лечения не отличаются.
H1: Доля пациентов, вернувшихся к нормальной физической активности после лечения новым методом больше, чем после стандартного лечения.

α = 0.05, квантили (0, 0.95)
Статистический тест: z-критерий для разности долей для независимых выборок, правосторонний (так как по гипотезе доля в группе с новым методом больше, чем в контрольной группе, это означает, что область критического значения лежит в правой части распределения).


```{r}
# Критическое значение Z-статистики (правосторонний тест)
alpha <- 0.05
critical_z_value <- qnorm(1 - alpha)

# Расчет статистических величин
new_method_success <- sum(activity[treatment == "Новый метод"])
standard_treatment_success <- sum(activity[treatment == "Стандартное лечение"])
n_new_method <- sum(treatment == "Новый метод")
n_standard_treatment <- sum(treatment == "Стандартное лечение")

p_new_method <- new_method_success / n_new_method
p_standard_treatment <- standard_treatment_success / n_standard_treatment

P <- (new_method_success + standard_treatment_success) / (n_new_method + n_standard_treatment) # объединенная доля

SQ <- P * (1 - P) * (1/n_new_method + 1/n_standard_treatment) 

#  Расчет Z-критерия
z_score <- (p_new_method - p_standard_treatment) / sqrt(SQ)

p_value <- 1 - pnorm(z_score)

cat("Z-статистика:", z_score, "\n")
cat("P-значение:", p_value, "\n")
cat("Критическое значение Z:", critical_z_value, "\n")
cat("Доля пациентов, вернувшихся к нормальной физической активности (Новый метод):", p_new_method, "\n")
cat("Доля пациентов, вернувшихся к нормальной физической активности (Стандартное лечение):", p_standard_treatment, "\n")

```

Z-статистика: 0.6591, P-значение: 0.255, критическое значение Z: 1.645. Мы не можем отвергнуть нулевую гипотезу.

# Гипотеза 5. 

Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- rbinom(sample_size, size = 1, prob = 0.5)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)

after <-rbinom(sample_size, size = 1, prob = 0.2)

#Создание таблицы сопряженности:

table_stress_meditation <- table(before, after)

```

## Решение

H0: Доля людей без стресса после нового метода медитации равна 50% 
H1: Доля людей без стресса после нового метода медитации больше 50% 
α = 0.05, квантили (0, 0.95)
Статистический тест: точный критерий для доли, правостроронний (так как ожидаем долю людей без стресса больше).
```{r}

# Подсчет числа людей, у которых снизился уровень стресса после медитации
successes <- sum(after == 0)

# Биномиальный тест
binom_test_result <- binom.test(successes, sample_size, p = 0.5, alternative = "greater")

# Вывод результатов
print(binom_test_result)
```

p-value = 2.105e-09, 95 percent confidence interval: 0.801167 - 1.000000. Отклоняем нулевую гипотезу.

Практическая значимость: probability of success - 0.9. Медитация действительно существенно влияет на вероятность снижения уровня стресса в группе.

# Гипотеза 6. 

Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- runif(sample_size, min = 40, max = 70)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- runif(sample_size, min = 53, max = 83)  # контрольная группа

```

## Решение

H0: Средний уровень депрессии в группе с альтернативным методом лечения равен среднему уровню в группе со стандартным лечением. 

Н1: Средний уровень депрессии в группе с альтернативным методом лечения меньше, чем в группе со стандартным лечением.

α = 0.05, квантили (0.05, 1)
Статистический тест: U-критерий Манна-Уитни.Он подходит для сравнения двух независимых выборок и не требует предположений о нормальности распределения.Левосторонний тест (гипотеза о том, что в группе с новым лечением среднее меньше).

Табличное критическое значение 81

```{r}

print(wilcox.test_result <- wilcox.test(group1, group2, alternative = "less"))

mean_difference <- mean(group2) - mean(group1)

cat("Наблюдаемое значение статистики (W):", wilcox.test_result$statistic, "\n")
cat("P-значение:", wilcox.test_result$p.value, "\n")
cat("Разница в средних значениях:", mean_difference, "\n")

```

Отклоняем нулевую гипотезу. 

Практическая значимость: разница между группами составляет 11.6, что может быть клинически значимо, особенно если уменьшение уровня депрессии связано с улучшением состояния пациентов.

# Гипотеза 7. 

Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

Н0: Корреляция между длительностью сна и уровнем стресса равна нулю.
Н1: Существует отрицательная корреляция между продолжительностью сна и уровнем стресса.
α=0.05, квантили (0.05, 1)
Статистический тест: тест на корреляцию Пирсона, односторонний (отрицательная корреляция).

```{r}

library(ggplot2)

print(correlation_test <- cor.test(df$HoursOfSleep, df$StressLevel, alternative = "l", method = "pearson"))

ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)+
  labs(x = "Длительность сна (часы)", y = "Уровень стресса") +
  ggtitle("Ассоциация между длительностью сна и уровнем стресса")+
  theme_bw()

cat("Наблюдаемый коэффициент корреляции (r):", cor(df$HoursOfSleep, df$StressLevel), "\n")
cat("P-значение:", correlation_test$p.value, "\n")

```

Нулевую гипотезу отвергаем.

Практическая значимость: p=-0.5222265, сила корреляции умеренная:  0.3≤∣ρ∣<0.7








